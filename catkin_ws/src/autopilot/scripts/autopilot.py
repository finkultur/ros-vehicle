#!/usr/bin/env python
import rospy, sys, roslib
import ap_utils
import math
import time
from std_msgs.msg import String
from ackermann_msgs.msg import AckermannDrive
from estimate_position.msg import Position

last_drive_msg = AckermannDrive()
current_steering_angle = 0
current_wp = 0
finished = False

#wps = [(0.0,0.0),(0.5,0.0),(1.0,0.0),(1.5,0.0),(2.0,0.0),(2.5,0.5),(3.0,1.0),(3.0,1.5),(3.0,2.0),(2.5,1.5),(2.0,2.0),(1.5,2.0),(1.0,2.0),(0.5,2.0),(0.0,2.0)]
#wps = [(0,0),(1,0),(2,1),(2,2),(1,2.5),(0,2),(0,0)]

# An ellipse
#wps = [(2.0,0.0),(2.4,0.1),(2.7,0.2),(3.0,0.3),(3.3,0.4),(3.6,0.6),(3.8,0.9),(3.9,1.2),(3.9,1.5),(3.8,1.7),(3.7,2.0),(3.4,2.1),(3.1,2.2),(2.6,2.2),(2.1,2.2),(1.6,2.2),(1.1,2.1),(0.7,1.9),(0.5,1.6),(0.4,1.3),(0.3,1.0),(0.5,0.7),(0.7,0.5),(0.9,0.3),(1.4,0.1),(1.7,0.0)]
# Another ellipse
#wps = [(2.0,0.0),(4.0,0.0),(6.4,1.0),(7.1,2.6),(6.2,4.2),(4.4,4.9),(2.7,4.9),(1.1,4.2),(0.5,2.5),(0.9,0.9)]

# An eight. Probably wont work
#wps = [(2.0,0.0),(2.3,0.1),(2.5,0.2),(2.7,0.4),(2.9,0.6),(2.9,0.9),(2.9,1.2),(2.6,1.5),(2.4,1.6),(2.1,1.8),(1.7,2.0),(1.3,2.3),(0.9,2.5),(0.5,2.7),(0.3,2.9),(0.3,3.4),(0.6,3.8),(1.0,4.0),(1.5,4.1),(1.9,4.1),(2.3,3.9),(2.5,3.5),(2.5,3.0),(2.2,2.6),(1.9,2.3),(1.6,2.1),(1.3,1.6),(0.9,1.2),(0.7,0.8),(0.6,0.4),(1.0,0.1),(1.5,0.0)]

# Banana + loop
#wps = {(2.6,0.0),(3.2,0.0),(3.7,0.1),(4.1,0.1),(4.5,0.1),(5.1,0.2),(5.5,0.3),(5.7,0.6),(6.0,0.9),(6.2,1.2),(6.3,1.6),(6.3,2.1),(6.3,2.6),(6.1,2.9),(5.6,3.2),(5.2,3.5),(5.0,4.0),(4.7,4.6),(3.8,5.1),(2.8,5.2),(2.0,5.0),(1.6,4.3),(2.0,3.8),(2.6,3.4),(3.3,3.1),(3.6,2.6),(3.7,1.9),(3.4,1.1),(2.8,0.8),(2.0,0.9),(1.5,1.4),(1.4,2.0),(1.6,2.5),(2.3,2.8),(3.1,2.8),(4.0,2.7),(4.4,2.1),(4.5,1.5),(4.4,0.9),(4.0,0.6),(3.4,0.4),(3.0,0.2),(2.6,0.2)}

#wps = (0,0),(0.46,0.19),(1.48,0.6),(2.22,0.6),(2.86,0.6),(3.66,0.6),(4.4,0.6),(4.83,0.88),(5.26,1.12),(5.5,1.44),(5.55,1.84),(5.53,2.28),(5.53,7.2),(5.4,7.8),(5.2,8.25),(4.7,8.4),(4.3,8.4),(1.8,8.4),(1.1,8.3),(0.7,8.1),(0.7,2.16)

# Forward and turn left
#wps = [(0,0),(3,0),(5,1),(6,2),(6,3.5)]

# Around the whole track (not the inner part)
#wps = [(2.015,0.585),(4.20,0.585),(4.78,0.72),(5.3,1.08),(5.56,1.52),(5.66,1.96),(5.5,5.5),(5.3,7.77),(5.1,8.35),(5,8.7),(4.5,9.0),(3.6,9.3),(3,9.4),(2.3,9.38),(1.3,9.3),(0.9,8.9),(0.6,8.6),(0.5,8.0),(0.46,1.9),(0.74,1.3),(1.12,0.94),(1.6,0.7),(2.015,0.585)]


# Stop in box
#wps = [(2.015, 0.585), (4.28, 1.92), (4.32, 4.20), (4.40, 6.52)]

# Whole outer track
#wps = [(2.015, 0.565),(4.24, 0.56),(5.66,1.96),(5.14,8.16),(2.24,9.3), (0.58, 6.5),(0.58,2.32), (2.015, 0.565)]

# Whole outer track 2 times
#wps = [(2.015, 0.565),(4.24, 0.56),(5.66,1.96),(5.14,8.16),(2.24,9.3), (0.58, 6.5),(0.58,2.32), (2.015, 0.565), (4.24, 0.56),(5.66,1.96),(5.14,8.16),(2.24,9.3), (0.58, 6.5),(0.58,2.32), (2.015, 0.565)]

# track0.jpg
#wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77)]

# track1.jpg
#wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77),(5.63,-4.97),(5.59,-5.23),(5.47,-5.51),(5.30,-5.70),(5.13,-5.89),(4.89,-6.06),(4.03,-6.66),(3.60,-6.84),(3.34,-6.93),(3.09,-6.96),(2.81,-6.96),(2.60,-6.90),(2.37,-6.83),(2.11,-6.73),(1.91,-6.54),(1.71,-6.30),(1.56,-5.99),(1.47,-5.74),(1.40,-5.39),(1.36,-4.87),(1.36,-4.41),(1.36,-3.99),(1.39,-3.56),(1.43,-3.16),(1.53,-2.76),(1.64,-2.30),(1.84,-2.07),(2.09,-1.80),(2.49,-1.61),(2.89,-1.53),(3.26,-1.53),(3.60,-1.59),(3.94,-1.71),(4.21,-1.86),(4.43,-2.04),(4.59,-2.33),(4.66,-2.66),(4.71,-2.96),(4.71,-3.21),(4.63,-3.46),(4.46,-3.64),(4.36,-3.86),(4.21,-4.03),(4.07,-4.29),(3.94,-4.53),(3.87,-4.77),(3.86,-5.07),(3.84,-5.31),(3.87,-5.59),(3.96,-5.80),(4.04,-6.00),(4.19,-6.21),(4.37,-6.40)]

# track2.jpg
#wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77),(5.63,-4.97),(5.59,-5.23),(5.47,-5.51),(5.30,-5.70),(5.13,-5.89),(4.89,-6.06),(4.03,-6.66),(3.60,-6.84),(3.34,-6.93),(3.09,-6.96),(2.81,-6.96),(2.60,-6.90),(2.37,-6.83),(2.11,-6.73),(1.91,-6.54),(1.71,-6.30),(1.56,-5.99),(1.47,-5.74),(1.40,-5.39),(1.36,-4.87),(1.36,-4.41),(1.36,-3.99),(1.39,-3.56),(1.43,-3.16),(1.53,-2.76),(1.64,-2.30),(1.84,-2.07),(2.09,-1.80),(2.49,-1.61),(2.89,-1.53),(3.26,-1.53),(3.60,-1.59),(3.94,-1.71),(4.21,-1.86),(4.43,-2.04),(4.59,-2.33),(4.66,-2.66),(4.71,-2.96),(4.71,-3.21),(4.63,-3.46),(4.46,-3.64),(4.36,-3.86),(4.21,-4.03),(4.07,-4.29),(3.94,-4.53),(3.87,-4.77),(3.86,-5.07),(3.84,-5.31),(3.87,-5.59),(3.96,-5.80),(4.04,-6.00),(4.19,-6.21),(4.37,-6.40),(4.64,-6.69),(4.83,-6.90),(4.99,-7.14),(5.16,-7.46),(5.23,-7.66),(5.26,-7.84),(5.27,-8.07),(5.29,-8.33),(5.21,-8.60),(5.06,-8.84),(4.84,-9.03),(4.61,-9.17),(4.26,-9.26),(3.96,-9.24),(3.59,-9.24),(3.24,-9.16),(2.87,-9.17),(2.46,-9.26),(2.13,-9.26),(1.83,-9.26),(1.53,-9.21),(1.29,-9.16),(1.09,-9.01),(0.91,-8.79),(0.81,-8.51),(0.71,-8.21),(0.66,-7.91),(0.66,-7.60),(0.66,-1.96),(0.73,-1.67),(0.81,-1.40),(0.93,-1.17),(1.06,-1.03),(1.20,-0.90),(1.40,-0.76),(1.60,-0.64),(1.81,-0.57),(3.13,-0.53)]

# track3.jpg
#wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77),(5.63,-4.97),(5.59,-5.23),(5.47,-5.51),(5.30,-5.70),(5.13,-5.89),(4.89,-6.06),(4.03,-6.66),(3.60,-6.84),(3.34,-6.93),(3.09,-6.96),(2.81,-6.96),(2.60,-6.90),(2.37,-6.83),(2.11,-6.73),(1.91,-6.54),(1.71,-6.30),(1.56,-5.99),(1.47,-5.74),(1.40,-5.39),(1.36,-4.87),(1.36,-4.41),(1.36,-3.99),(1.39,-3.56),(1.43,-3.16),(1.53,-2.76),(1.64,-2.30),(1.84,-2.07),(2.09,-1.80),(2.49,-1.61),(2.89,-1.53),(3.26,-1.53),(3.60,-1.59),(3.94,-1.71),(4.21,-1.86),(4.43,-2.04),(4.59,-2.33),(4.66,-2.66),(4.71,-2.96),(4.71,-3.21),(4.63,-3.46),(4.46,-3.64),(4.36,-3.86),(4.21,-4.03),(4.07,-4.29),(3.94,-4.53),(3.87,-4.77),(3.86,-5.07),(3.84,-5.31),(3.87,-5.59),(3.96,-5.80),(4.04,-6.00),(4.19,-6.21),(4.37,-6.40),(4.64,-6.69),(4.83,-6.90),(4.99,-7.14),(5.16,-7.46),(5.23,-7.66),(5.26,-7.84),(5.27,-8.07),(5.29,-8.33),(5.21,-8.60),(5.06,-8.84),(4.84,-9.03),(4.61,-9.17),(4.26,-9.26),(4.06,-9.26),(3.81,-9.26),(1.67,-9.20),(1.39,-9.16),(1.11,-9.04),(0.93,-8.90),(0.76,-8.69),(0.63,-8.46),(0.57,-8.17),(0.57,-7.90),(0.57,-7.66),(0.56,-1.99),(0.59,-1.76),(0.67,-1.57),(0.76,-1.44),(0.87,-1.30),(0.99,-1.14),(1.14,-1.00),(1.31,-0.86),(1.44,-0.77),(1.61,-0.67),(1.79,-0.59),(2.20,-0.50),(2.54,-0.47),(3.11,-0.49)]

# track4.jpg
#wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77),(5.63,-4.97),(5.59,-5.23),(5.47,-5.51),(5.30,-5.70),(5.13,-5.89),(4.89,-6.06),(4.03,-6.66),(3.60,-6.84),(3.34,-6.93),(3.09,-6.96),(2.81,-6.96),(2.60,-6.90),(2.37,-6.83),(2.11,-6.73),(1.91,-6.54),(1.71,-6.30),(1.56,-5.99),(1.47,-5.74),(1.40,-5.39),(1.36,-4.87),(1.36,-4.41),(1.36,-3.99),(1.39,-3.56),(1.43,-3.16),(1.53,-2.76),(1.64,-2.30),(1.84,-2.07),(2.09,-1.80),(2.49,-1.61),(2.89,-1.53),(3.26,-1.53),(3.60,-1.59),(3.94,-1.71),(4.21,-1.86),(4.43,-2.04),(4.59,-2.33),(4.66,-2.66),(4.71,-2.96),(4.71,-3.21),(4.63,-3.46),(4.51,-3.66),(4.36,-3.86),(4.21,-4.03),(4.07,-4.29),(3.94,-4.53),(3.87,-4.77),(3.86,-5.07),(3.84,-5.31),(3.87,-5.59),(3.96,-5.80),(4.04,-6.00),(4.19,-6.21),(4.37,-6.40),(4.64,-6.69),(4.83,-6.90),(4.99,-7.14),(5.16,-7.46),(5.23,-7.66),(5.26,-7.84),(5.27,-8.07),(5.29,-8.33),(5.21,-8.60),(5.06,-8.84),(4.84,-9.03),(4.61,-9.17),(4.26,-9.26),(4.06,-9.26),(3.81,-9.26),(1.67,-9.20),(1.39,-9.16),(1.11,-9.04),(0.93,-8.90),(0.76,-8.69),(0.63,-8.46),(0.57,-8.17),(0.57,-7.90),(0.57,-7.66),(0.56,-1.99),(0.59,-1.76),(0.67,-1.57),(0.76,-1.44),(0.87,-1.30),(0.99,-1.14),(1.14,-1.00),(1.31,-0.86),(1.44,-0.77),(1.61,-0.67),(1.79,-0.59),(2.20,-0.50),(2.54,-0.47),(3.11,-0.49)]

# track5.jpg
wps = [(2.06,-0.56),(4.29,-0.56),(4.56,-0.59),(4.80,-0.64),(5.00,-0.73),(5.16,-0.84),(5.30,-0.96),(5.41,-1.09),(5.51,-1.24),(5.61,-1.41),(5.67,-1.61),(5.71,-1.79),(5.71,-1.97),(5.66,-4.77),(5.63,-4.97),(5.59,-5.23),(5.47,-5.51),(5.30,-5.70),(5.13,-5.89),(4.89,-6.06),(4.03,-6.66),(3.60,-6.84),(3.34,-6.93),(3.09,-6.96),(2.81,-6.96),(2.60,-6.90),(2.37,-6.83),(2.11,-6.73),(1.91,-6.54),(1.71,-6.30),(1.56,-5.99),(1.47,-5.74),(1.40,-5.39),(1.36,-4.87),(1.36,-4.41),(1.36,-3.99),(1.39,-3.56),(1.43,-3.16),(1.53,-2.76),(1.64,-2.30),(1.84,-2.07),(2.09,-1.80),(2.49,-1.61),(2.89,-1.53),(3.26,-1.53),(3.60,-1.59),(3.94,-1.71),(4.21,-1.86),(4.43,-2.04),(4.59,-2.33),(4.66,-2.66),(4.71,-2.96),(4.71,-3.21),(4.63,-3.46),(4.51,-3.66),(4.36,-3.86),(4.21,-4.03),(4.07,-4.29),(3.94,-4.53),(3.87,-4.77),(3.86,-5.07),(3.84,-5.31),(3.87,-5.59),(3.96,-5.80),(4.04,-6.00),(4.19,-6.21),(4.37,-6.40),(4.64,-6.69),(4.83,-6.90),(4.99,-7.14),(5.16,-7.46),(5.23,-7.66),(5.26,-7.84),(5.27,-8.07),(5.29,-8.33),(5.21,-8.60),(5.06,-8.84),(4.84,-9.03),(4.00,-9.33),(4.33,-9.27),(4.61,-9.17),(3.46,-9.30),(1.67,-9.20),(1.39,-9.16),(1.11,-9.04),(0.93,-8.90),(0.76,-8.69),(0.63,-8.46),(0.57,-8.17),(0.57,-7.90),(0.57,-7.66),(0.56,-1.99),(0.59,-1.76),(0.67,-1.57),(0.76,-1.44),(0.87,-1.30),(0.99,-1.14),(1.14,-1.00),(1.31,-0.86),(1.44,-0.77),(1.61,-0.67),(1.79,-0.59),(2.20,-0.50),(2.54,-0.47),(3.11,-0.49)]


# This is needed since we are getting coordinates that starts with (0,0) in top
# left corner.
#wps = ap_utils.negate_y(wps)

def callback_position(pos, pub):
  global last_drive_msg, current_steering_angle, current_wp, wps, finished

  #rospy.loginfo(rospy.get_name() + 
  #  "Got a new position: x=%f, y=%f, heading=%f\n" %
  #  (pos.x, pos.y, pos.heading))

  drive = AckermannDrive()

  # If we are close enough to current waypoint, aim for next.
  # If at final waypoint, stop the car.
  if (abs(wps[current_wp][0]-pos.x) < 0.2) and (abs(wps[current_wp][1]-pos.y) < 0.2):
    if current_wp < len(wps)-1:
      rospy.loginfo("I reached waypoint %i!" % (current_wp))
      current_wp += 1
    elif current_wp == len(wps)-1:
      rospy.loginfo("I reached my destination!\n")
      finished = True
  elif ap_utils.is_point_behind_front(wps[current_wp][0], wps[current_wp][1],
                                    pos.x, pos.y, pos.heading) and not finished:
    rospy.loginfo("I missed waypoint %i!" % (current_wp))
    current_wp += 1

  if not finished:
    drive.speed = 0.40
  else:
    drive.speed = 0.00
  
  # If more than x meters away from start, stop the car
  if abs(pos.x) > 5 or abs(pos.y) > 5:
    #drive.speed = 0.0
    pass

  # Set steering angle based on next waypoint
  current_steering_angle = ap_utils.update_steering_angle(
    wps[current_wp][0],wps[current_wp][1],
    pos.x, pos.y, pos.heading, current_steering_angle)
  drive.steering_angle = math.degrees(current_steering_angle)

  
  if drive != last_drive_msg:
    last_drive_msg = drive
    # Publish under topic 'mc_cmds'
    pub.publish(drive)


def autopilot():
  # Sleep before starting. If parameter not set, default to 5 seconds.
  time.sleep(int(rospy.get_param('wait_time', '5')))

  rospy.init_node("autopilot", anonymous=True)

  # Publish under topic 'mc_cmds'
  pub = rospy.Publisher('mc_cmds', AckermannDrive, queue_size=10)

  # Subscribe to Position
  rospy.Subscriber("Position", Position, callback_position, pub)

  rospy.spin()


if __name__ == '__main__':
  try:
    autopilot()
  except rospy.ROSInterruptException: pass

